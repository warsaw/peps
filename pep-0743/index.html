
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 743 – Add Py_COMPAT_API_VERSION to the Python C API | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0743/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 743 – Add Py_COMPAT_API_VERSION to the Python C API | peps.python.org'>
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0743/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="Python Enhancement Proposals (PEPs)">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 743</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 743 – Add Py_COMPAT_API_VERSION to the Python C API</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Victor Stinner &lt;vstinner&#32;&#97;t&#32;python.org&gt;</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">11-Mar-2024</dd>
<dt class="field-odd">Python-Version<span class="colon">:</span></dt>
<dd class="field-odd">3.13</dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#python-releases-enforce-c-api-changes">Python releases enforce C API changes</a></li>
<li><a class="reference internal" href="#limited-c-api">Limited C API</a></li>
<li><a class="reference internal" href="#deprecation-and-compiler-warnings">Deprecation and compiler warnings</a></li>
<li><a class="reference internal" href="#schedule-changes">Schedule changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#new-macros">New macros</a></li>
<li><a class="reference internal" href="#example-in-python">Example in Python</a></li>
<li><a class="reference internal" href="#goals">Goals</a></li>
<li><a class="reference internal" href="#non-goals">Non-goals</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples-of-py-compat-api-version-usages">Examples of <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> usages</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#discussions">Discussions</a></li>
<li><a class="reference internal" href="#prior-art">Prior Art</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Add <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION_MAX</span></code> macros
to opt-in for planned incompatible C API changes in a C extension.
Maintainers can decide when they make their C extension compatible
and also decide which future Python version they want to be compatible
with.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<section id="python-releases-enforce-c-api-changes">
<h3><a class="toc-backref" href="#python-releases-enforce-c-api-changes" role="doc-backlink">Python releases enforce C API changes</a></h3>
<p>Every Python 3.x release has a long list of C API changes, including
incompatible changes. C extensions have to be updated to work on the
newly released Python.</p>
<p>Some incompatible changes are driven by new features: they cannot be
avoided, unless we decide to not add these features. Other reasons:</p>
<ul class="simple">
<li>Remove deprecated API (see <a class="pep reference internal" href="../pep-0387/" title="PEP 387 – Backwards Compatibility Policy">PEP 387</a>).</li>
<li>Ease the implementation of another change.</li>
<li>Change or remove error-prone API.</li>
</ul>
<p>Currently, there is no middle ground between “not change the C API” and
“incompatible C API changes impact everybody”. Either a C extension is
updated or the new Python version cannot be used. Such all-or-nothing
deal does not satisfy C extension maintainers nor C extensions users.</p>
</section>
<section id="limited-c-api">
<h3><a class="toc-backref" href="#limited-c-api" role="doc-backlink">Limited C API</a></h3>
<p>The limited C API is versioned: the <code class="docutils literal notranslate"><span class="pre">Py_LIMITED_API</span></code> macro can be set
to a Python version to select which API is available. On the Python
side, it allows introducing incompatible changes at a specific
<code class="docutils literal notranslate"><span class="pre">Py_LIMITED_API</span></code> version. For example, if <code class="docutils literal notranslate"><span class="pre">Py_LIMITED_API</span></code> is set to
Python 3.11 or newer, the <code class="docutils literal notranslate"><span class="pre">&lt;stdio.h&gt;</span></code> is no longer included by
<code class="docutils literal notranslate"><span class="pre">Python.h</span></code>, whereas C extensions targeting Python 3.10 are not
affected.</p>
<p>The difference here is that upgrading Python does not change if
<code class="docutils literal notranslate"><span class="pre">&lt;stdio.h&gt;</span></code> is included or not, but updating <code class="docutils literal notranslate"><span class="pre">Py_LIMITED_API</span></code> does.
Updating <code class="docutils literal notranslate"><span class="pre">Py_LIMITED_API</span></code> is an deliberate action made by the C
extension maintainer. It gives more freedom to decide <strong>when</strong> the
maintainer is ready to deal with the latest batch of incompatible
changes.</p>
<p>A similar version can be used with the regular (non-limited) C API.</p>
</section>
<section id="deprecation-and-compiler-warnings">
<h3><a class="toc-backref" href="#deprecation-and-compiler-warnings" role="doc-backlink">Deprecation and compiler warnings</a></h3>
<p>Deprecated functions are marked with <code class="docutils literal notranslate"><span class="pre">Py_DEPRECATED()</span></code>. Using a
deprecated function emits a compiler warning.</p>
<p>The problem is that <code class="docutils literal notranslate"><span class="pre">pip</span></code> and <code class="docutils literal notranslate"><span class="pre">build</span></code> tools hide compiler logs by
default, unless a build fails.  Moreover, it’s easy to miss a single
warning in the middle of hundred lines of logs.</p>
</section>
<section id="schedule-changes">
<h3><a class="toc-backref" href="#schedule-changes" role="doc-backlink">Schedule changes</a></h3>
<p>Currently, there is no way to schedule a C API change: announce it but
also provide a way to maintainers to test their C extensions with the
change. Either a change is not made, or everybody must update their code
if they want to update Python.</p>
</section>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<section id="new-macros">
<h3><a class="toc-backref" href="#new-macros" role="doc-backlink">New macros</a></h3>
<p>Add new <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION_MAX</span></code>
macros. They can be set to test if a C extension is prepared for future
C API changes: compatible with future Python versions.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> macro can be set to a specific Python
version. For example, <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION=0x030e0000</span></code> tests C API
changes scheduled in Python 3.14.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> macro is set to
<code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION_MAX</span></code>, all scheduled C API changes are tested at
once.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> macro is not set, it is to
<code class="docutils literal notranslate"><span class="pre">PY_VERSION_HEX</span></code> by default.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> macro can be set in a single C file or for
a whole project in compiler flags. The macro does not affected other
projects or Python itself.</p>
</section>
<section id="example-in-python">
<h3><a class="toc-backref" href="#example-in-python" role="doc-backlink">Example in Python</a></h3>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">PyImport_ImportModuleNoBlock()</span></code> function is
deprecated in Python 3.13 and scheduled for removal in Python 3.15. The
function can be declared in the Python C API with the following
declaration:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if Py_COMPAT_API_VERSION &lt; 0x030f0000</span>
<span class="n">Py_DEPRECATED</span><span class="p">(</span><span class="mf">3.13</span><span class="p">)</span><span class="w"> </span><span class="n">PyAPI_FUNC</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">PyImport_ImportModuleNoBlock</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="w">            </span><span class="cm">/* UTF-8 encoded string */</span>
<span class="w">    </span><span class="p">);</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">Py_COMPAT_API_VERSION</span></code> is equal to or greater than Python 3.15
(<code class="docutils literal notranslate"><span class="pre">0x030f0000</span></code>), the <code class="docutils literal notranslate"><span class="pre">PyImport_ImportModuleNoBlock()</span></code> function is not
declared, and so using it fails with a build error.</p>
</section>
<section id="goals">
<h3><a class="toc-backref" href="#goals" role="doc-backlink">Goals</a></h3>
<ul class="simple">
<li>Reduce the number of C API changes affecting C extensions when
updating Python.</li>
<li>When testing C extensions (for example, optional CI test),
<code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> can be set to <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION_MAX</span></code>
to detect future incompatibilities. For mandatory tests, it is
recommended to set <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> to a specific Python
version.</li>
<li>For core developers, make sure that the C API can still evolve
without being afraid of breaking an unknown number of C extensions.</li>
</ul>
</section>
<section id="non-goals">
<h3><a class="toc-backref" href="#non-goals" role="doc-backlink">Non-goals</a></h3>
<ul class="simple">
<li>Freeze the API forever: this is not the stable ABI. For example,
deprecated functions will continue to be removed on a regular basis.</li>
<li>C extensions maintainers not using <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> will
still be affected by C API changes when updating Python.</li>
<li>Provide a stable ABI: the macro only impacts the regular (non-limited)
API.</li>
<li>Silver bullet solving all C API issues.</li>
</ul>
</section>
</section>
<section id="examples-of-py-compat-api-version-usages">
<h2><a class="toc-backref" href="#examples-of-py-compat-api-version-usages" role="doc-backlink">Examples of <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> usages</a></h2>
<ul class="simple">
<li>Remove deprecated functions.</li>
<li>Remove deprecated structure members, such as
<code class="docutils literal notranslate"><span class="pre">PyBytesObject.ob_shash</span></code>.</li>
<li>Remove a standard <code class="docutils literal notranslate"><span class="pre">#include</span></code>, such as <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;string.h&gt;</span></code>,
from <code class="docutils literal notranslate"><span class="pre">&lt;Python.h&gt;</span></code>.</li>
<li>Change the behavior of a function or a macro. For example, calling
<code class="docutils literal notranslate"><span class="pre">PyObject_SetAttr(obj,</span> <span class="pre">name,</span> <span class="pre">NULL)</span></code> can fail, to enforce the usage
of the <code class="docutils literal notranslate"><span class="pre">PyObject_DelAttr()</span></code> function instead to delete an attribute.</li>
</ul>
</section>
<section id="implementation">
<h2><a class="toc-backref" href="#implementation" role="doc-backlink">Implementation</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/python/cpython/issues/116587">Issue gh-116587</a></li>
<li>PR: <a class="reference external" href="https://github.com/python/cpython/pull/116588">Add Py_COMPAT_API_VERSION and Py_COMPAT_API_VERSION_MAX macros</a></li>
</ul>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>There is no impact on backward compatibility.</p>
<p>Adding <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> and <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION_MAX</span></code>
macros has no effect on backward compatibility. Only developers setting
the <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> macro in their project will be impacted by
effects of this macro which is the expected behavior.</p>
</section>
<section id="discussions">
<h2><a class="toc-backref" href="#discussions" role="doc-backlink">Discussions</a></h2>
<ul class="simple">
<li>C API Evolutions: <a class="reference external" href="https://github.com/capi-workgroup/api-evolution/issues/24">Macro to hide deprecated functions</a>
(October 2023)</li>
<li>C API Problems: <a class="reference external" href="https://github.com/capi-workgroup/problems/issues/54">Opt-in macro for a new clean API? Subset of functions
with no known issues</a>
(June 2023)</li>
</ul>
</section>
<section id="prior-art">
<h2><a class="toc-backref" href="#prior-art" role="doc-backlink">Prior Art</a></h2>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Py_LIMITED_API</span></code> macro of <a class="pep reference internal" href="../pep-0384/" title="PEP 384 – Defining a Stable ABI">PEP 384</a> “Defining a Stable ABI”.</li>
<li>Rejected <a class="pep reference internal" href="../pep-0606/" title="PEP 606 – Python Compatibility Version">PEP 606</a> “Python Compatibility Version” which has a global
scope.</li>
</ul>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0743.rst">https://github.com/python/peps/blob/main/peps/pep-0743.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0743.rst">2024-03-11 20:44:01 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a><ul>
<li><a class="reference internal" href="#python-releases-enforce-c-api-changes">Python releases enforce C API changes</a></li>
<li><a class="reference internal" href="#limited-c-api">Limited C API</a></li>
<li><a class="reference internal" href="#deprecation-and-compiler-warnings">Deprecation and compiler warnings</a></li>
<li><a class="reference internal" href="#schedule-changes">Schedule changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#new-macros">New macros</a></li>
<li><a class="reference internal" href="#example-in-python">Example in Python</a></li>
<li><a class="reference internal" href="#goals">Goals</a></li>
<li><a class="reference internal" href="#non-goals">Non-goals</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples-of-py-compat-api-version-usages">Examples of <code class="docutils literal notranslate"><span class="pre">Py_COMPAT_API_VERSION</span></code> usages</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#discussions">Discussions</a></li>
<li><a class="reference internal" href="#prior-art">Prior Art</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0743.rst">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
</body>
</html>